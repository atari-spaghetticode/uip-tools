<!DOCTYPE html>
<html lang="en">
<head>
    <title id='Description'>uiptool</title>
    <style> 
<!-- cut -->
    </style>
    <script>
<!-- cut -->
    </script>

#include "icon.inc"

    <script type="text/javascript">

        // This returns at least 32bit int with date encoded for DOSTIME struct
        // typedef struct
        // {
        //      uint16_t     time;  /* Time like Tgettime */
        //      uint16_t     date;  /* Date like Tgetdate */
        // } DOSTIME;
        var convertDateToAtariTOSFormat = function(date) {
            var tosYear = (date.getFullYear() - 1980);
            tosYear = tosYear < 0 ? 0 : tosYear;
            tosYear = tosYear > 119 ? 119 : tosYear;
            var tosDay = date.getDate();
            var tosMonth = date.getMonth() + 1;
            var tosDate = (tosYear) << 9 | (tosMonth << 5) | tosDay;
            var tosSeconds = date.getSeconds() / 2;
            var tosMinutes = date.getMinutes();
            var tosHours = date.getHours();
            var tosTime = (tosHours << 11) | (tosMinutes<<5) | tosSeconds;
            return ((tosTime<<16) | tosDate) >>> 0;
        }

        var drophandler = function (ev,localpath) {
            if (ev.preventDefault) {
                ev.preventDefault(); // Necessary. Allows us to drop.
            }

            console.log( ev.type + " event target path " + localpath );

            ev.stopPropagation(); // Stops some browsers from redirecting.
            ev.preventDefault();

            var uploadFile = function(path,file) {

                $("#FileQueueTreeGrid").jqxTreeGrid('addRow', job_key, {
                    name: localpath + "/" + path + file.name,
                    size: file.size,
                    status: "queued"
                    });

                var reader = new FileReader();
                reader.onload = (function(name,key,path,date) {
                    return function(event) {

                        var xhr = new XMLHttpRequest;
                        xhr.open("POST", localpath + "/" + path + name + "?setfiledate=" + convertDateToAtariTOSFormat(date), true);
                        console.log(localpath + "/" + path + name);
                        var blob = new Blob([event.target.result], {type: 'application/octet-binary'});
                        //xhr.send( blob ) ;
                        job_add(xhr,blob,key);
                    };
                })(file.name,job_key,path,file.lastModifiedDate);

                job_key++;

                reader.readAsArrayBuffer(file);
            };


            try {
                // check chrome folder api first
                function traverseFileTree(item, path) {
                  path = path || "";
                  if (item.isFile) {
                    // Get file
                    item.file(function(file) {
                      uploadFile(path,file);
                    });
                  } else if (item.isDirectory) {
                    // Get folder contents
                    var dirReader = item.createReader();
                    dirReader.readEntries(function(entries) {
                      for (var i=0; i<entries.length; i++) {
                        traverseFileTree(entries[i], path + item.name + "/");
                      }
                    });
                  }
                }

                var items = ev.dataTransfer.items;
                for (var i=0; i<items.length; i++) {
                    // webkitGetAsEntry is where the magic happens
                    var item = items[i].webkitGetAsEntry();
                    if (item) {
                      traverseFileTree(item);
                    }
                }
            } catch(err) {
                var files = ev.dataTransfer.files;
                for (var i = 0, f; f = files[i]; i++) {
                    uploadFile("",f);
                }
            }
            
        };

        function allowDrop(event) {
            event.preventDefault();
        }

        function fileListDrop(event){
            if (event.preventDefault) {
                event.preventDefault(); // Necessary. Allows us to drop.
            }
            
            console.log( event.type + " event" );
        }

        var fetchDirectory = function (path,query)
        {
            var my_data;
            $.ajax({
                type: 'GET',
                url: path + query,
                success: function(result) { my_data = result; },
                data: { },
                async: false
            });

            var arr = $.parseJSON( my_data );

            for (i = 0; i < arr.length; i++) { 
                // prepare full host path
                arr[i]["path"] = path + "/" + arr[i]["name"];
                // prepare string to sort with
                arr[i]["zort"] = arr[i]["type"] + path + "/" + arr[i]["name"];
            }

            return arr;
        }

        var populateGridList = function(items) {
            if ( items != null ) {

                for (i = 0; i < items.length; i++) {
                    var item = items[i];
                    item.name = "<a href=" + item.path + ">" + item.name + "</a>"; 
                }

            }
        }

        var fetchAndParseDir = function(path,query) {

            current_path = path;

            var items = [];
            var files = [];

            var dirtree = fetchDirectory(path,query);
            var item_index = 0;

            for (i = 0; i < dirtree.length; i++) {
                // prepare full host path
                if ( dirtree[i].type == "d") {
                    items[item_index] = {};
                    items[item_index]["value"] = dirtree[i];
                    items[item_index]["label"] =  dirtree[i]["name"];
                    items[item_index]["expanded"] =  false;
                    items[item_index]["items"] =  [{ "value": "ajax1.htm", "label": "Loading..." }];
                    item_index++;
                } else {
                    if ( dirtree[i]["size"] < 0x80000000 ) {
                        var row = { "name": dirtree[i]["name"] , "size": dirtree[i]["size"], "path": path+'/'+dirtree[i]["name"] };
                        files.push(row);
                    }
                }
            }

            return [items,files];
        }

        var populateDragDropHandlers = function(items) {
            for (i = 0; i < items.length; i++) {
                if ( items[i].subtreeElement != null ) {
                    items[i].subtreeElement.ondrag = dragdropdefault;
                    items[i].subtreeElement.ondragend = dragdropdefault;
                    items[i].subtreeElement.ondragenter = dragdropdefault;
                    items[i].subtreeElement.ondragleave = dragdropdefault;
                    items[i].subtreeElement.ondragover = dragdropdefault;
                    items[i].subtreeElement.ondragstart = dragdropdefault;
                    items[i].subtreeElement.ondrop = drophandler;
                }
            }
        }

        $(document).ready(function () {

            var current_path = '/';




            $('#folderListTree').on("added", function (event) {
                var rootitems = 'fwfwf';
                var items = event.args.items;
             //   populateDragDropHandlers(rootitems);
            });

            $('#folderListTree').on("expand", function (event) {

                var $element = $(event.args.element);
                //if ( obj.value.subtree == null ) 
                {
                    var dir = fetchAndParseDir(obj.value.path,"/?dir");
                    obj.value.subtree = dir[1];

                    if ( dir[0].length > 0 ) {
                        while ( obj.subtreeElement.firstChild != null ) {
                        }
                    } else {
                    }
                }
                populateGridList(obj.value.subtree);
            });

            $('#folderListTree').on("collapse", function (event) {
                var obj = $('#folderListTree').jqxTree("getItem", event.args.element);
                var $element = $(event.args.element);

                while ( obj.subtreeElement.firstChild != null ) {
                    $('#folderListTree').jqxTree('removeItem', obj.subtreeElement.firstChild );
                    console.log("2");
                }
            });

            $('#folderListTree').on("select", function (event) {
                var obj = $('#folderListTree').jqxTree("getItem", event.args.element);
                populateGridList(obj.value.subtree);
                $('#navigationBar').val(obj.value.path + "/");
            });

            // populate file lists
            var dir = fetchAndParseDir("","?dir");
            var source = dir[0];
            populateGridList(dir[1]);

            $('#FileListTreeGrid').on('rowClick', function (event) {
            });

            $('#FileListTreeGrid').on("rowSelect", function (event) {
                $('#navigationBar').val(event.args.row.path);
            });

            // new folder callback
            $('#button-new-folder').on('click', function () {
            });

            $('#rightSplitter').on('resize', function (event)  { 
                var panels = event.args.panels;
            });

        });
    </script>
    <style type="text/css">
        html, body
        {
            height: 100%;
            width: 100%;
            margin: 0px;
            padding: 0px;
            overflow: hidden;
          clear:both;

        }

        #Containiner {
             margin: 2px;
             width: 100%;
             height: 7%;
             }

        #Containiner2 {
            float:left;
             }
        #Containiner3 {
            float:right;
             }
        #Containiner4 {
             width: 100%;
            float:bottom;
             }

    </style>
</head>
<body>

    <div id="Containiner" >
        <div id="Containiner2" >
                <font size="6">uIPTool</font> by Mystic Bytes, ver. VERSION
        </div>

        <div id="Containiner3">
                <input type="button" value="New Folder" id='button-new-folder' />
                <input type="button" value="Delete" id='button-delete' />
                <input type="button" value="Run" id='button-run' />
        </div>
        <div id="Container4" style="clear:both;float:bottom;">
               <b>Location:</b> <input type="text" id="navigationBar"/>
        </div>
    </div>

    <div id="mainSplitter" ondrop="fileListDrop(event);" ondragover="event.preventDefault()" ondragenter="event.preventDefault()">
        <div id="folderListTree"></div>
        <div>
            <div id="rightSplitter">
                <div id="FileListTreeGrid"></div>
                <div id="FileQueueTreeGrid"> </div>
            </div>
        </div>
    </div>

    <div id="enter-folder-name-window">
        <div>
            <img width="14" height="14" src="../../images/help.png" alt="" /> Modal Window
        </div>
        <div>
            <div>
                <input type="text" id="input-folder-name"/>
            </div>
            <div>
            <div style="float: right; margin-top: 15px;">
                <input type="button" id="ok" value="OK" style="margin-right: 10px" />
                <input type="button" id="cancel" value="Cancel" />
            </div>
            </div>
        </div>
    </div>

</body>
</html>
